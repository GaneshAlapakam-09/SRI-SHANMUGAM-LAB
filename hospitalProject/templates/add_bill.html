<!DOCTYPE html>
<html>
<head>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="description" content="Materia - Admin Template">
	<meta name="keywords" content="materia, webapp, admin, dashboard, template, ui">
	<meta name="author" content="solutionportal">
	<!-- <base href="/"> -->

	<title>SSL</title>
	
	{% load static %}
	<link rel="icon" type="image/x-icon" href="{% static 'images/ssl_Logo.webp' %}">

<!-- Font Styles -->
<link rel="stylesheet" href="{% static 'fonts/font-awesome/css/font-awesome.min.css' %}">
<link rel="stylesheet" href="{% static 'fonts/ionicons/css/ionicons.min.css' %}">

<!-- Plugins -->
<link rel="stylesheet" href="{% static 'styles/plugins/c3.css' %}">
<link rel="stylesheet" href="{% static 'styles/plugins/waves.css' %}">
<link rel="stylesheet" href="{% static 'styles/plugins/perfect_scrollbar.css' %}">

<!-- CSS Stylesheets -->
<link rel="stylesheet" href="{% static 'styles/bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static 'styles/main.min.css' %}">





<link href="https://unpkg.com/ionicons@4.5.10-0/dist/css/ionicons.min.css" rel="stylesheet">
 	<link href='http://fonts.googleapis.com/css?family=Roboto:400,500,700,300' rel='stylesheet' type='text/css'>

	<!-- Match Media polyfill for IE9 -->
	<!--[if IE 9]> <script src="scripts/ie/matchMedia.js"></script>  <![endif]--> 

	
	<style>
		.panel-heading.addbill-heading{
			display:flex;
			justify-content:space-between;
			align-items:center;
		}
		th {
			white-space: nowrap;
		}
		.dropdown.form-dropdown{
			width: 100%; /* Full width */
			padding: 8px;
			border: 0px;
			font-size: 16px;
			border-bottom: 2px solid #ccc;
			border-radius: 0px;
			background-color: #fff;
			cursor: pointer;
			outline: none;
			transition: border-color 0.3s, box-shadow 0.3s;
		}
		
		/* Focus effect */
		.dropdown.form-dropdown:focus {
			border-color: #007bff;
			box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
		}
		
		/* Disabled option */
		.dropdown.form-dropdown option:disabled {
			color: #aaa;
		}
		
		/* Hover effect */
		.dropdown.form-dropdown:hover {
			border-color: #0056b3;
		}
		
		/* Custom styling for when dropdown is open */
		.dropdown.form-dropdown:active,
		.dropdown.form-dropdown:focus-within {
			background-color: #f9f9f9;
		}
		#phoneError{
			color:red;
		}

		/* Style the autocomplete dropdown */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
            z-index: 99;
        }
        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
        }
        .autocomplete-items div:hover {
            background-color: #f1f1f1;
        }
	</style>
</head>
<body id="app" class="app off-canvas">
	
	<!-- header -->
	<header class="site-head" id="site-head">
		<ul class="list-unstyled left-elems">
			<!-- nav trigger/collapse -->
			<li>
				<a href="javascript:;" class="nav-trigger icon ion-md-menu"></a>
			</li>
			<!-- #end nav-trigger -->

			<!-- site-logo for mobile nav -->
			<li>
				<div class="site-logo visible-xs">
					<a href="javascript:;" class="text-uppercase h3">
						<span class="text">SSL</span>
					</a>
				</div>
			</li> <!-- #end site-logo -->


			
		</ul>
        <ul class="list-unstyled right-elems">
			<!-- profile drop -->
			<li class="profile-drop hidden-xs dropdown">
				<a href="javascript:;" data-toggle="dropdown">
					<img src="{% static 'images/user.png' %}" alt="admin-pic">
				</a>
				<ul class="dropdown-menu dropdown-menu-right">
					<li><a href=""><span class="ion ion-md-exit">&nbsp;&nbsp;</span>Logout</a></li>
				</ul>
			</li>
			<!-- #end profile-drop -->

			

		</ul>

		<ul class="list-unstyled right-elems">
			


		</ul>


	</header>
	<!-- #end header -->

	<!-- main-container -->
	<div class="main-container clearfix">
		<!-- main-navigation -->
		<aside class="nav-wrap" id="site-nav" data-perfect-scrollbar>
			<div class="nav-head">
				<!-- site logo -->
				<a href="{% url 'dashboard' %}" class="site-logo text-uppercase">
					{% comment %} <i class="ion ion-disc"></i> {% endcomment %}
					<img src="{% static 'images/ssl_Logo.webp' %}" alt="">
					<span class="text">SS Lab</span>
				</a>
			</div>

			<!-- Site nav (vertical) -->

			<nav class="site-nav clearfix" role="navigation">
				

				<!-- navigation -->
				<ul class="list-unstyled clearfix nav-list mb15">
					<li class="active">
						<a href="{% url "dashboard" %}">
							<i class="ion ion-monitor"></i>
							<span class="text">Dashboard</span>
						</a>
					</li>

					
					<li>
						<a href="javascript:;">
							<i class="icon ion-md-paper"></i>
							<span class="text">Billing Management</span>
							{% comment %} <i class="icon ion-md-arrow"></i> {% endcomment %}
						</a>
						<ul class="inner-drop list-unstyled">
							<li><a href="{% url 'addbill' %}">Add Bill</a></li>
							<li><a href="{% url 'listbill' %}">List Bill</a></li>
						</ul>
					</li>
					<li>
						<a href="javascript:;">
							<i class="icon ion-md-medkit"></i>
							<span class="text">Test Management</span>
							{% comment %} <i class="icon ion-md-arrow"></i> {% endcomment %}
						</a>
						<ul class="inner-drop list-unstyled">
								<li><a href="{% url 'addtest' %}">Add Test</a></li>
							<li><a href="{% url 'listtest' %}">List Test</a></li>
						</ul>
					</li>
				</ul> <!-- #end navigation -->
			</nav>
		</aside>
		<!-- #end main-navigation -->

		<div class="content-container fixedHeader nav-expand">
			<!-- col-left -->
			<div class="col-sm-12 col-md-11">
				<div class="panel panel-default panel-hovered panel-stacked mb30">
					
					<div class="panel-heading addbill-heading">
						<div>Add Bill</div>
						<div><a class="btn btn-primary mr5" href="{% url 'listbill' %}">List Bill</a></div>
					</div>
					{% if messages %}

        {% for message in messages %}
        <script type="text/javascript">
            alert('{{ message }}');
        </script>
        {% endfor %}
        
        {% endif %}
					<div class="panel-body">
						<form id='form' class="form-horizontal"  method="POST">
							{% csrf_token %}
							 <!-- form horizontal acts as a row -->

							 <!-- Choose Type -->
								
							<!-- Name -->
							<div class="form-group">
								<label class="col-md-3 control-label">Name *</label>
								<div class="col-md-1">
									<select name="title" id="title" class="dropdown form-dropdown" required>
										<option value=""readonly>Title</option>
										<option value="Mr">Mr</option>
										<option value="Mrs">Mrs</option>
										<option value="Miss">Miss</option>
										<option value="Baby">Baby</option>
										<option value="Master">Master</option>
                                    </select> 
								</div>
								<div class="col-md-4">
									<input type="text" class="form-control" name="name" placeholder="Name" required>
								</div>
								<div class="col-md-4">
									<input type="text" class="form-control" name="last_name" placeholder="Last Name" required>
								</div>
							</div>
                            {% comment %} <!-- DOB -->
							<div class="form-group">
								<label class="col-md-3 control-label">DOB</label>
								<div class="col-md-9">
									<input type="date" id="dob" class="form-control" placeholder="DOB" name="dob" required >
								</div>
							</div> {% endcomment %}
                            <!-- AGE -->
							<div class="form-group">
								<label class="col-md-3 control-label">Age</label>
								<div class="col-md-3">
									<input type="number" class="form-control" placeholder="Years" name="years" id="years">
								</div>
							<div class="col-md-3">
									<input type="number" class="form-control" placeholder="Months" name="months" id="months">
								</div>
								<div class="col-md-3">
									<input type="number" class="form-control" placeholder="Days" name="days" id="days">
								</div>
							</div>

							<!-- Gender -->
							<div class="form-group">
								<label class="col-md-3 control-label">Gender *</label>
								<div class="col-md-9">
									<select name="gender" id="gender" class="dropdown form-dropdown" required>
										<option value="" disabled selected>Gender</option>
										<option value="Male">Male</option>
										<option value="Female">Female</option>
										<option value="Others">Others</option>
                                    </select> 
								</div>
							</div>

							<!-- Phone -->
							<div class="form-group">
								<label class="col-md-3 control-label">Phone *</label>
								<div class="col-md-4">
									<input type="number" class="form-control" placeholder="Phone No." id="phone" name="phone" required>
									<span id="phoneError"></span>
								</div>
                                <div class="col-md-5">
									<input type="number" class="form-control" placeholder="Alternative Phone No." name="alt_phone" >
								</div>
							</div>
							
							<!-- Email -->
							<div class="form-group">
								<label class="col-md-3 control-label">Email</label>
								<div class="col-md-9">
									<input type="email" class="form-control" placeholder="Email" name="email" >
								</div>
							</div>
							<!-- Refered By -->
							<div class="form-group">
								<label class="col-md-3 control-label">Refered By *</label>
								<div class="col-md-9">
									<input type="text" class="form-control" placeholder="Refered By" name="reference" required>
								</div>
							</div>
						

							
							
							<!-- Address -->
							<div class="form-group">
								<label class="col-md-3 control-label">Address</label>
								<div class="col-md-9">
									<textarea rows="3" class="form-control resize-v" placeholder="Address" name="address" ></textarea>
								</div>
							</div>

                            <!-- Particulars -->
							<div class="form-group">
								<label class="col-md-3 control-label">Particulars</label>
								<div class="col-md-9">
									<input type="text" id="search" placeholder="Search here.." class="form-control"  name="particulars" autocomplete="off" />
									<div id="autocomplete-list" class="autocomplete-items"></div>
								</div>
							</div>

                            <!-- Price -->
							<div class="form-group">
								<label class="col-md-3 control-label">Price</label>
								<div class="col-md-9">
									<input type="number" class="form-control" placeholder="Price" id="price" name="price" >
								</div>
							</div>

							<center>
								<button class="btn btn-primary mr5" type="submit" id="addButton">Add</button>
							</center>
							
						</form>

					</div>
					

					<div class="panel-body">

						<!-- Table Display -->
						<center>
							<h2>Test List</h2>
						</center>
						<table class="table table-bordered" id="particularsTable">
						    <thead>
						        <tr>
						            <th>S.No</th>
						            <th>Particular</th>
						            <th>Price</th>
						            <th>Action</th>
						        </tr>
						    </thead>
						    <tbody></tbody>
						</table>

						<!-- Grand Total and Discount -->
						<div class="form-group">
						    <label>Grand Total: â‚¹<span id="grandTotal">0</span></label>
						</div>
						<div class="form-group">
							<div class="col-md-6">
						    	<label for="discount">Discount</label>
						    	<input type="number" class="form-control" id="discount" value=0 placeholder="Discount" />
							</div>
							<div class="col-md-6">
								<label for="Advance">Advance</label>
						    	<input type="number" class="form-control" id="advance" value=0 placeholder="Advance" />
							</div>
						</div>

					</div>
					
						<!-- Submit Button -->
					<div style="padding:20px">
						<center>
							<button type="button" class="btn btn-success" id="submitButton">Submit All</button>
						</center>
					</div>

					
				</div>
			</div> <!-- #end col-left -->

		</div>

		<!-- content-here -->
		<div class="content-container" id="content">
			<!-- dashboard page -->
			<div class="page page-dashboard">

				<div class="page-wrap">


					

				</div> <!-- #end page-wrap -->
			</div>
			<!-- #end dashboard page -->
		</div>

		
	</div> <!-- #end main-container -->
	

	<!-- theme settings -->
	<div class="site-settings clearfix hidden-xs" >
		<div class="settings clearfix">
			<div class="trigger ion ion-settings left"></div>
			<div class="wrapper left">
				<ul class="list-unstyled other-settings">
					<li class="clearfix mb10">
						<div class="left small">Nav Horizontal</div>
						<div class="md-switch right">
							<label>
								<input type="checkbox" id="navHorizontal"> 
								<span>&nbsp;</span> 
							</label>
						</div>
						
						
					</li>
					<li class="clearfix mb10">
						<div class="left small">Fixed Header</div>
						<div class="md-switch right">
							<label>
								<input type="checkbox"  id="fixedHeader"> 
								<span>&nbsp;</span> 
							</label>
						</div>
					</li>
					<li class="clearfix mb10">
						<div class="left small">Nav Full</div>
						<div class="md-switch right">
							<label>
								<input type="checkbox"  id="navFull"> 
								<span>&nbsp;</span> 
							</label>
						</div>
					</li>
				</ul>
				<hr/>
				<ul class="themes list-unstyled" id="themeColor">
					<li data-theme="theme-zero"></li>
					<li data-theme="theme-one"></li>
					<li data-theme="theme-two"></li>
					<li data-theme="theme-three" class="active"></li>
					<li data-theme="theme-four"></li>
					<li data-theme="theme-five"></li>
					<li data-theme="theme-six"></li>
					<li data-theme="theme-seven"></li>
				</ul>
			</div>
		</div>
	</div>
	<!-- #end theme settings -->


	

	<!-- Dev only -->
	<!-- Vendors -->
	{% load static %}

	
	<script src="{% static 'scripts/vendors.js' %}"></script>
	<script src="{% static 'scripts/plugins/d3.min.js' %}"></script>
	<script src="{% static 'scripts/plugins/c3.min.js' %}"></script>
	<script src="{% static 'scripts/plugins/screenfull.js' %}"></script>
	<script src="{% static 'scripts/plugins/perfect-scrollbar.min.js' %}"></script>
	<script src="{% static 'scripts/plugins/waves.min.js' %}"></script>
	<script src="{% static 'scripts/plugins/jquery.sparkline.min.js' %}"></script>
	<script src="{% static 'scripts/plugins/jquery.easypiechart.min.js' %}"></script>
	<script src="{% static 'scripts/plugins/bootstrap-rating.min.js' %}"></script>
	<script src="{% static 'scripts/app.js' %}"></script>
	<script src="{% static 'scripts/index.init.js' %}"></script>

	<script>
		  // Phone number validation
		  const phoneInput = document.getElementById('phone');
		  const phoneError = document.getElementById('phoneError');
	  
		  phoneInput.addEventListener('input', function () {
			const phone = this.value.trim();
			if (/^\d{10}$/.test(phone)) {
			  phoneError.textContent = '';
			  phoneError.style.color = '';
			} else {
			  phoneError.textContent = 'Phone number must be exactly 10 digits.';
			  phoneError.style.color = 'red';
			}
		  });
	  
		  // Prevent form submission if phone number is invalid
		  const form = document.getElementById('form');
		  form.addEventListener('submit', function (e) {
			const phone = phoneInput.value.trim();
			if (!/^\d{10}$/.test(phone)) {
			  phoneError.textContent = 'Phone number must be exactly 10 digits.';
			  phoneError.style.color = 'red';
			  e.preventDefault();
			}
		  });
		};
	  </script>



<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Sample data (you will replace this with Django dynamic data)
        var customerData = [
            {% for item in data %}
                "{{ item.Test_Name}} --- {{item.Price}}",
            {% endfor %}
        ];

        var input = document.getElementById("search");
        var autocompleteList = document.getElementById("autocomplete-list");

        input.addEventListener("input", function () {
            var val = this.value;
            autocompleteList.innerHTML = ""; // Clear previous results

            if (!val) return; // Stop if input is empty

            customerData.forEach(function (item) {
                if (item.toLowerCase().includes(val.toLowerCase())) {
                    var suggestion = document.createElement("div");
                    suggestion.textContent = item;
                    suggestion.addEventListener("click", function () {
						const parts = item.split(" --- ");
						// Set each part to the respective inputs
						input.value = parts[0]; // First part to original input
                        document.getElementById("price").value = parts[1]; // Second part to input2 (if exists)
                        autocompleteList.innerHTML = ""; // Hide dropdown
                    });
                    autocompleteList.appendChild(suggestion);
                }
            });
        });

        document.addEventListener("click", function (e) {
            if (!input.contains(e.target) && !autocompleteList.contains(e.target)) {
                autocompleteList.innerHTML = ""; // Hide dropdown when clicking outside
            }
        });
    });
</script>

<script>
	let sNo = 1;
	let grandTotal = 0;
	
	document.getElementById("addButton").addEventListener("click", function (e) {
		e.preventDefault();
	
		const particular = document.getElementById("search").value;
		const price = parseFloat(document.getElementById("price").value);
	
		if (particular && !isNaN(price)) {
			const table = document.getElementById("particularsTable").querySelector("tbody");
			const row = table.insertRow();
			
			row.innerHTML = `
				<td>${sNo}</td>
				<td><input type="hidden" name="table_particular[]" value="${particular}">${particular}</td>
				<td><input type="hidden" name="table_price[]" value="${price}">${price.toFixed(2)}</td>
				<td><button type="button" class="btn btn-danger btn-sm deleteRow">Delete</button></td>
			`;
	
			sNo++;
			grandTotal += price;
			document.getElementById("grandTotal").innerText = grandTotal.toFixed(2);
	
			// Reset only Particulars and Price
			document.getElementById("search").value = "";
			document.getElementById("price").value = "";
	
			// Delete functionality
			row.querySelector(".deleteRow").addEventListener("click", function () {
				const rowPrice = parseFloat(row.cells[2].innerText);
				grandTotal -= rowPrice;
				document.getElementById("grandTotal").innerText = grandTotal.toFixed(2);
				row.remove();
				updateSerialNumbers();
			});
		}
	});
	
	function updateSerialNumbers() {
		const rows = document.querySelectorAll("#particularsTable tbody tr");
		sNo = 1;
		rows.forEach(row => {
			row.cells[0].innerText = sNo++;
		});
	}
	document.getElementById("submitButton").addEventListener("click", function () {
		const form = document.getElementById("form");
	
		// Validate required inputs
		const requiredFields = form.querySelectorAll("[required]");
		let allValid = true;
	
		requiredFields.forEach(field => {
			if (!field.value.trim()) {
				allValid = false;
				field.classList.add("is-invalid");
			} else {
				field.classList.remove("is-invalid");
			}
		});
	
		if (!allValid) {
			alert("Please fill all required fields.");
			return;
		}
	
		// Check table rows
		const particulars = document.getElementsByName("table_particular[]");
		const prices = document.getElementsByName("table_price[]");
	
		if (particulars.length === 0) {
			alert("Please add at least one item to the table.");
			return;
		}
	
		// Discount validation
		const discount = document.getElementById("discount").value;
		const advance = document.getElementById("advance").value;
		if (discount === "") {
			alert("Please enter a discount or set it to 0.");
			return;
		}
	
		// Collect regular form fields into an object
		const formFields = {};
		const inputs = form.querySelectorAll("input, select, textarea");
	
		inputs.forEach(input => {
			if (!input.name || input.name.startsWith("table_")) return; // Skip table inputs
			formFields[input.name] = input.value;
		});
	
		// Collect dynamic table data
		const items = [];
		for (let i = 0; i < particulars.length; i++) {
			items.push({
				particular: particulars[i].value,
				price: prices[i].value
			});
		}
	
		// Add everything into one JSON object
		const payload = {
			...formFields, // Spread form fields
			grand_total: parseFloat(grandTotal.toFixed(2)),
			discount: discount,
			advance: advance,
			items: items
		};
	
		// Send the request
		fetch("", {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
				"X-CSRFToken": "{{ csrf_token }}"
			},
			body: JSON.stringify(payload)
		})
		.then(response => response.json())
		.then(data => {
			alert("Submitted successfully!");

			// Clear table rows
			const tableBody = document.getElementById("particularsTable").querySelector("tbody");
			tableBody.innerHTML = ""; // Removes all rows

			// Reset the form
			form.reset();
			discount.value = 0;
			sNo = 1;
			grandTotal = 0;
			document.getElementById("grandTotal").innerText = 0;
			document.getElementById("discount").value = 0;
			const phoneErr = document.getElementById('phoneError');
			phoneErr.textContent = '';
			

		})
		.catch(error => console.error("Error submitting data:", error));
	});
	
	
	
	</script>
	
	  
	  
</body>
</html>